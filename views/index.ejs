<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Text Editor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/darcula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>
    <style>
        .CodeMirror {
            height: calc(100vh - 56px);
        }

        .foreign-cursor {
            position: absolute;
            width: 2px;
            z-index: 10;
        }

        .foreign-selection {
            position: absolute;
            z-index: 5;
            opacity: 0.3;
        }

        body[data-bs-theme="dark"] .foreign-cursor,
        body[data-bs-theme="dark"] .foreign-selection {
            opacity: 0.6;
        }
        
    </style>
</head>

<body data-bs-theme="light">
    <!-- Toolbar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Text Editor</a>
            <div class="d-flex">
                <input type="file" id="fileInput" class="btn btn-outline-primary me-2">
                <button class="btn btn-outline-success me-2" id="downloadBtn">Download File</button>
                <button class="btn btn-outline-secondary" id="darkModeToggle">Toggle Dark Mode</button>
            </div>
        </div>
    </nav>

    <!-- Text Editor -->
    <textarea id="editor"></textarea>

    <!-- Room ID Modal -->
    <div class="modal fade" id="roomModal" tabindex="-1" aria-labelledby="roomModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="roomModalLabel">Enter Room ID</h5>
                </div>
                <div class="modal-body">
                    <div class="mb-3 input-group">
                        <input type="text" class="form-control" id="roomIdInput" placeholder="Room ID">
                        <button class="btn btn-secondary" id="copyLinkBtn"><i class="bi bi-clipboard"></i></button>
                    </div>
                    <button class="btn btn-primary" id="generateIdBtn">Generate Random ID</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="joinRoomBtn">Join Room</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script>
        const socket = io();
        let room = '';

        let fileName = 'file.txt';

        const editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
            mode: "javascript",
            lineNumbers: true,
            theme: localStorage.getItem('theme') === 'dark' ? 'darcula' : 'default'
        });

        let isLocalChange = false;
        const colors = {};
        const cursors = {};
        const selections = {};
        const userColors = [
            '#FF5733', '#33FF57', '#3357FF', '#F3FF33', '#FF33F3', '#33FFF3', '#F33FFF'
        ];

        function getRandomColor() {
            return userColors[Math.floor(Math.random() * userColors.length)];
        }

        function generateRandomId(length = 8) {
            return Math.random().toString(36).substring(2, length + 2).toUpperCase();
        }

        function updateRoomIdInput(id) {
            document.getElementById('roomIdInput').value = id;
        }

        function getRoomFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('room');
        }

        const autoJoinRoom = getRoomFromURL();
        if (autoJoinRoom) {
            room = autoJoinRoom;
            socket.emit('joinRoom', room);
        }

        document.getElementById('fileInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    editor.setValue(e.target.result);
                    socket.emit('textChange', editor.getValue());
                    socket.emit('fileNameChange', file.name);
                    fileName = file.name;
                    document.getElementById('fileInput').value = '';
                };
                reader.readAsText(file);
            }
        });

        socket.on('fileNameChange', (name) => {
            fileName = name;
        });
        
        document.getElementById('downloadBtn').addEventListener('click', () => {
            const text = editor.getValue();
            const blob = new Blob([text], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = fileName;
            a.click();
        });

        document.getElementById('darkModeToggle').addEventListener('click', () => {
            changeTheme();
        });

        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            changeTheme(savedTheme);
        }

        editor.on('change', () => {
            if (!isLocalChange) {
                socket.emit('textChange', editor.getValue());
            }
            isLocalChange = false;
        });

        editor.on('cursorActivity', () => {
            const cursor = editor.getCursor();
            const selection = editor.listSelections();
            socket.emit('cursorChange', { cursor, selection });
        });

        socket.on('cursorChange', (data) => {
            if (!colors[data.id]) {
                colors[data.id] = getRandomColor();
            }

            if (cursors[data.id]) {
                cursors[data.id].clear();
            }

            cursors[data.id] = editor.markText(
                { line: data.cursor.line, ch: data.cursor.ch },
                { line: data.cursor.line, ch: data.cursor.ch + 1 },
                { className: 'foreign-cursor', css: `border-left: 2px solid ${colors[data.id]};` }
            );

            if (selections[data.id]) {
                selections[data.id].clear();
            }

            selections[data.id] = editor.markText(
                { line: data.selection[0].anchor.line, ch: data.selection[0].anchor.ch },
                { line: data.selection[0].head.line, ch: data.selection[0].head.ch },
                { className: 'foreign-selection', css: `background-color: ${colors[data.id]}; opacity: 0.4;` }
            );
        });

        socket.on('cursorRemove', (id) => {
            if (cursors[id]) {
                cursors[id].clear();    
                delete cursors[id];
            }
            if (selections[id]) {
                selections[id].clear();
                delete selections[id];
            }
            delete colors[id];
        });

        function changeTheme(theme = null) {
            const currentTheme = document.body.getAttribute('data-bs-theme');
            const newTheme = theme || (currentTheme === 'light' ? 'dark' : 'light');
            document.body.setAttribute('data-bs-theme', newTheme);
            editor.setOption('theme', newTheme === 'dark' ? 'darcula' : 'default');
            localStorage.setItem('theme', newTheme);

            for (let id in selections) {
                if (selections[id]) {
                    selections[id].clear();
                    selections[id] = null;
                }
            }
        }

        socket.on('textChange', (data) => {
            if (editor.getValue() !== data) {
                isLocalChange = true;
                const currentCursorPos = editor.getCursor();
                editor.setValue(data);
                editor.setCursor(currentCursorPos);
            }
        });



        const roomModal = new bootstrap.Modal(document.getElementById('roomModal'), {
            backdrop: 'static',
            keyboard: false
        });

        const urlParams = new URLSearchParams(window.location.search);

        if (!urlParams.has('room')) {
            roomModal.show();
        } else {
            room = urlParams.get('room');
            socket.emit('joinRoom', room);
        }

        document.getElementById('generateIdBtn').addEventListener('click', () => {
            const newId = generateRandomId();
            updateRoomIdInput(newId);
        });

        document.getElementById('copyLinkBtn').addEventListener('click', () => {
            const link = `http://localhost:3000/?room=${document.getElementById('roomIdInput').value}`;
            navigator.clipboard.writeText(link).then(() => {
                document.getElementById('copyLinkBtn').innerHTML = '<i class="bi bi-clipboard-check"></i>';
                setTimeout(() => {
                    document.getElementById('copyLinkBtn').innerHTML = '<i class="bi bi-clipboard"></i>';
                }, 1000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        });

        document.getElementById('joinRoomBtn').addEventListener('click', () => {
            room = document.getElementById('roomIdInput').value.trim();
            if (room) {
                socket.emit('joinRoom', room);
                roomModal.hide();
            } else {
                alert('Please enter a valid Room ID');
            }
        });
    </script>
</body>

</html>